---
title: "Mendelian Randomization and MR-DoC2"
subtitle: "HGEN619"
author: "Luis Castro-de-Araujo ^[Post-doc T32. luis.araujo@vcuhealth.org  \n]"
date: "`r format(Sys.time(), '%d %B, %Y' )`"
lang: en-AU
output:
  html_notebook:
    code_folding: hide
    highlight: zenburn
    theme: flatly
    toc: yes
    df_print: paged    
    toc_float: yes
    code_downloading: yes
---


```{r setup, include=FALSE}

library(readr)
library(umx)
library(dplyr)
library(kableExtra)
library(TwoSampleMR)
library(readr)


# R options
options(
  digits = 4, # Only two decimal digits
  scipen = 999 # Remove scientific notation
)

```

The script is based on the following paper:

- Castro-de-Araujo LFS, Singh M, Zhou Y, et al (2022) MR-DoC2: Bidirectional Causal Modeling with Instrumental Variables and Data from Relatives. Behav Genet. https://doi.org/10.1007/s10519-022-10122-x



# TwoSampleMR()



```{r}

# List available GWASs
ao <- available_outcomes()

# write in disk to save your time
# saveRDS(ao, "ao.rds")


```


In order to explore the data set you can use the below code to pick the study with the largest sample size.
You can change the string to whatever you are interested in. Not necessary to run this as I already know what 
I want you to test, so `eval = F`.

```{r eval=F}

ao |> 
filter(stringr::str_detect(trait,"C-reactive")) |>
  dplyr::select(id, trait, author, year, pmid, sample_size) |>
  arrange(desc(sample_size)) |>
  knitr::kable()

```


|id               |trait                     |author       | year|     pmid| sample_size|
|:----------------|:-------------------------|:------------|----:|--------:|-----------:|
|bbj-a-14         |C-reactive protein        |Ishigaki K   | 2019| 29403010|       75391|
|ieu-b-4764       |C-reactive protein        |Howe LJ      | 2021|       NA|       61308|
|ieu-b-4763       |C-reactive protein        |Howe LJ      | 2021|       NA|       20623|
|ebi-a-GCST008055 |C-reactive protein levels |Wojcik GL    | 2019| 31217584|       15912|
|ieu-a-1015       |C-reactive protein        |Okada Y      | 2016| 21196492|       10112|
|ebi-a-GCST005067 |C-reactive protein levels |Prins BP     | 2017| 28887542|        9541|
: This is an example of how the output will look like. You can see that the largest sample size is 75391. 

Now let's follow David's example on CRP and BMI.

```{r}

# Extract BMI instrument
exposure_bmi <- extract_instruments("ukb-b-19953")

# Extract CRP instrument
exposure_crp <- extract_instruments("ieu-b-4764")

# CRP on BMI
outcome_bmi <- extract_outcome_data(snps=exposure_crp$SNP, outcomes = "ukb-b-19953")

# Get effects of instruments on outcome, BMI on CRP
outcome_crp <- extract_outcome_data(snps=exposure_bmi$SNP, outcomes = "ieu-b-4764")

# Harmonization of the exposure and outcome data
bmi_crp <- harmonise_data( exposure_bmi, outcome_crp)

# Harmonization of the exposure and outcome data
crp_bmi <- harmonise_data( exposure_crp, outcome_bmi)

```

Next step is to run the MR analysises. It cannot be easier than this:

```{r}

# In the direction of BMI causing inflammation
res_bmi_crp <- mr(bmi_crp)

# In the direction of inflammation BMI 
res_crp_bmi <- mr(crp_bmi)

```

Now we look at the results:

```{r}

res_bmi_crp |> 
dplyr::select(outcome, method, b, se, pval) |>
  knitr::kable(caption = "BMI causing inflammation (CRP)?")


res_crp_bmi |> 
  dplyr::select(outcome, method, b, se, pval) |>
  knitr::kable(caption = "Inflammation (CRP) causing BMI?")

```

If you are interested in the full report, just examine the objects `res_bmi_crp` or `res_crp_bmi`.

Q: Which direction of causation is supported by these findings?

This is too easy, isn't it? What about pleiotropy, we have discussed that the MR Egger intercept
significance can point to pleiotropy. Let's run this test:

```{r}

mr_pleiotropy_test(bmi_crp)

```

Now on to the plots, first the scatter plot:

```{r}

mr_scatter_plot(res_bmi_crp, bmi_crp)

res_single <- mr_singlesnp(bmi_crp)
mr_funnel_plot(res_single)

```


A funnel plot:

```{r}

res_single <- mr_singlesnp(bmi_crp)
mr_funnel_plot(res_single)

```


A forest plot:

```{r}


mr_forest_plot(res_single)

```

# Let's now extend classic MR with the twin design 


## MR-DoC I & II

You loaded a helper function at the beginning of this report. The function was written in such a way that if you pass on only one of the instruments,
it will run MR-DoC. If you pass on two instruments, it will run MR-DoC2. Let's see how it works.



```{r}

# Get se for first estimate in lm()
se <- function(x) summary(x)$coefficients[2,2]


Notes:

1. the order matters!
2. the mrdoc I part of the function is not sanctioned by original authors,
   my implementation has correct specification, but returns slightly different results.
   Still working on finding the reason.


You can either pass two objects with data for MZs and DZs, or you can pass one object
with data for all twins, but with an extra column for zygosity: 



```{r}

simdata <- read.csv("simdata.csv")

model  <- umxMRDoC(pheno = c("BMI", "CRP"), prss = c("PSBMI"),
                    data = simdata, zyg = "zygosity")

umxSummary(model, CI = T)

summary(model, refModels = mxRefModels(model, run = T))
# modelCI <- umxCI(model, run = "if necessary")

# mxCheckIdentification(model)$status


```

Look at g1, this is the result of a MR-DoC1. Now change the `prss` argument to `c("GVBMI", "GVSBP")` and
you will get the result of a MR-DoC2. 


Q: What happens when we run the bidirectional version?



# Simulation information, for future reference


Instead of using Conor's simulation data, I have created my own. The reason is that I wanted to have a 
more realistic MR-DoC2 simulation with the BMI and CRP variance partitioning roughtly based on published 
data. I set instrument strenghts at 0.02, pleiotropy at 0.1, and the following partitioning:

BMI: AA = .72,  CC = .03, EE = .05
CRP: AA = .03, CC = 0.01,  EE = .10,


# System information

```{r}
sessionInfo()
```


